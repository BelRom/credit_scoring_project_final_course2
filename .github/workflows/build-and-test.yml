name: Build and Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"

jobs:
  # This job installs dependencies, runs linters, unit tests and security checks
  test-lint-scan:
    runs-on: ubuntu-latest
    steps:
      # Checkout repository contents so actions can access code
      - uses: actions/checkout@v4

      # Set up Python with caching of dependencies
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      # Install application and tooling dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Install additional tools for security analysis
          pip install bandit pip-audit

      # Code formatting check with Black
      - name: Black (format check)
        run: black --check .

      # Static analysis with Flake8
      - name: Flake8 (lint)
        run: flake8 src tests --config .flake8

      # Run unit tests
      - name: Pytest
        run: pytest -q --disable-warnings --maxfail=1

      # Validate data with Great Expectations checkpoint
      - name: Great Expectations validation
        run: great_expectations checkpoint run credit_default_checkpoint

      # Static security analysis of Python code
      - name: Bandit security scanning
        # Use || true to avoid failing the workflow on informational findings
        run: bandit -r src -lll || true

      # Dependency vulnerability scanning
      - name: Pip-audit dependency scanning
        run: pip-audit -r requirements.txt || true

  # This job builds Docker images for the API and frontend and pushes them to Docker Hub
  build-and-push:
    runs-on: ubuntu-latest
    needs: test-lint-scan
    env:
      DOCKER_BUILDKIT: 1
    steps:
      - uses: actions/checkout@v4

      # Authenticate to Docker Hub registry
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Prepare temporary files for secret injection into Docker build
      - name: Create temporary secret files
        run: |
          echo "${{ secrets.AWS_ACCESS_KEY_ID }}" > aws_key
          echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" > aws_secret

      # Build and push the API image with BuildKit and AWS secrets
      - name: Build and push API image
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker build \
            --secret id=aws_key,src=aws_key \
            --secret id=aws_secret,src=aws_secret \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/credit_api:$IMAGE_TAG \
            -f Dockerfile.api .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/credit_api:$IMAGE_TAG

      # Build and push the frontend image
      - name: Build and push Frontend image
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/credit_frontend:$IMAGE_TAG -f Dockerfile.frontend .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/credit_frontend:$IMAGE_TAG

      # Remove secret files after build
      - name: Clean up secret files
        run: rm -f aws_key aws_secret

      # Scan the API image for vulnerabilities using Trivy
      - name: Trivy scan API image
        run: |
          sudo apt-get update && sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/download/v0.50.2/trivy_0.50.2_Linux-64bit.deb
          sudo dpkg -i trivy_0.50.2_Linux-64bit.deb
          IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/credit_api:${{ github.sha }}
          trivy image --exit-code 0 --severity HIGH,CRITICAL $IMAGE

      # Scan the frontend image for vulnerabilities
      - name: Trivy scan Frontend image
        run: |
          IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/credit_frontend:${{ github.sha }}
          trivy image --exit-code 0 --severity HIGH,CRITICAL $IMAGE