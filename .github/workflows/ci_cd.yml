name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'

jobs:
  # -------------------------------------------------------------------------
  # Устанавливает зависимости Python, запускает проверки форматирования и линтинга,
  # выполняет модульные тесты, делает базовую проверку безопасности и собирает
  # Docker-образы для API и frontend. Публикует образы в Docker Hub с тегами SHA коммита.
  # -------------------------------------------------------------------------
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Форматирование и линтинг
      - name: Black (format check)
        run: black --check .

      - name: Flake8 (lint)
        run: flake8 src tests --config .flake8

      # Модульные тесты
      - name: Pytest
        run: pytest -q --disable-warnings --maxfail=1

      # Проверка данных через Great Expectations
      - name: Great Expectations validation
        env:
          GX_BASE_DIR: ${{ github.workspace }}
        run: great_expectations checkpoint run credit_default_checkpoint

      # Статический анализ безопасности Python-кода
      - name: Bandit (security)
        run: |
          pip install bandit && bandit -r src || true

      # Аудит зависимостей Python на уязвимости
      - name: pip-audit
        run: |
          pip install pip-audit && pip-audit || true

      # Авторизация в Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Сборка и публикация API-образа
      - name: Build and push API image
        env:
          DOCKER_BUILDKIT: 1
        run: |
          echo "${{ secrets.AWS_ACCESS_KEY_ID }}" > aws_key
          echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" > aws_secret
          docker build \
            --secret id=aws_key,src=aws_key \
            --secret id=aws_secret,src=aws_secret \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/credit_api:latest \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/credit_api:${{ github.sha }} \
            -f Dockerfile.api .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/credit_api:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/credit_api:${{ github.sha }}
          rm -f aws_key aws_secret

      # Сборка и публикация frontend-образа
      - name: Build and push frontend image
        run: |
          docker build \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/credit_frontend:latest \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/credit_frontend:${{ github.sha }} \
            -f Dockerfile.frontend .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/credit_frontend:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/credit_frontend:${{ github.sha }}

      # Сканирование API-образа на уязвимости
      - name: Trivy scan API image
        run: |
          docker run --rm aquasec/trivy:latest --ignore-unfixed --no-progress \
            --severity CRITICAL,HIGH,MEDIUM \
            ${{ secrets.DOCKERHUB_USERNAME }}/credit_api:${{ github.sha }} || true

      # Сканирование frontend-образа на уязвимости
      - name: Trivy scan Frontend image
        run: |
          docker run --rm aquasec/trivy:latest --ignore-unfixed --no-progress \
            --severity CRITICAL,HIGH,MEDIUM \
            ${{ secrets.DOCKERHUB_USERNAME }}/credit_frontend:${{ github.sha }} || true

  # -------------------------------------------------------------------------
  # Поскольку staging-деплой не требуется, задание выполняет один шаг и завершает работу.
  # Оставлено как шаблон, если staging понадобиться в будущем.
  # -------------------------------------------------------------------------
  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: always()
    steps:
      - name: Skip staging deployment
        run: echo "Staging deployment is disabled."

  # -------------------------------------------------------------------------
  # Выполняет деплой API в Kubernetes-кластер production.
  # Использует KUBECONFIG из секрета и обновляет манифесты и образ.
  # -------------------------------------------------------------------------
  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    steps:
      - uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure KUBECONFIG
        run: |
          echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > kubeconfig
          echo "KUBECONFIG=$PWD/kubeconfig" >> $GITHUB_ENV

      # Создание или обновление секрета AWS в кластере для DVC
      - name: Create/update AWS secret
        run: |
          kubectl delete secret credit-api-secrets --ignore-not-found
          kubectl create secret generic credit-api-secrets \
            --from-literal=AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
            --from-literal=AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # Применение манифестов Kubernetes
      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f infrastructure/k8s/configmap.yaml
          kubectl apply -f infrastructure/k8s/service.yaml
          kubectl apply -f infrastructure/k8s/ingress.yaml
          kubectl apply -f infrastructure/k8s/deployment.yaml

      # Обновление образа API и ожидание rollout
      - name: Update API image and rollout
        run: |
          kubectl set image deployment/credit-api credit-api=${{ secrets.DOCKERHUB_USERNAME }}/credit_api:${{ github.sha }} --record
          kubectl rollout status deployment/credit-api

      # Smoke-тест API через Ingress
      - name: Smoke test API
        run: |
          for i in {1..12}; do
            INGRESS_HOST=$(kubectl get ingress credit-api-ingress -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || true)
            if [ -z "$INGRESS_HOST" ]; then
              INGRESS_HOST=$(kubectl get ingress credit-api-ingress -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' || true)
            fi
            [ -n "$INGRESS_HOST" ] && break
            sleep 5
          done
          echo "Testing http://$INGRESS_HOST/api/health"
          curl -fsSL --max-time 20 http://$INGRESS_HOST/api/health

  # -------------------------------------------------------------------------
  # Выполняет базовую проверку работоспособности API.
  # -------------------------------------------------------------------------
  monitor:
    runs-on: ubuntu-latest
    needs: deploy-production
    steps:
      - name: Health check
        run: |
          INGRESS_HOST=$(kubectl get ingress credit-api-ingress -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || true)
          if [ -z "$INGRESS_HOST" ]; then
            INGRESS_HOST=$(kubectl get ingress credit-api-ingress -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' || true)
          fi
          curl -fsSL --max-time 20 http://$INGRESS_HOST/api/health